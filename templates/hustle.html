<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hustle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background:linear-gradient(#FBDB93, #BE5B50, #8A2D3B, #641B2E);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
            font-family: 'Quicksand', sans-serif;
            padding: 2rem;
            min-height: 100vh;
            overflow-y:auto;
        }

        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }

        .form-container{
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 2rem 3rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            backdrop-filter: blur(12px);
            animation: fadeInUp 0.6s ease-out;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background-color: #6fb1fc;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            width: 100%;
            font-weight: bold;
        }

        .btn-primary:hover {
             background-color:  #519fdc;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity:1;
                transform: translateY(0) scale(1);
            }
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!--Toast Flash Messages -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="toast align-items-center text-white bg-{{ 'success' if category == 'success' else 'danger' }} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                {{ message }}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!--Registration Form -->
    <form method="POST" class="form-container">
        <h2 class="text-center mb-4 text-dark fw-bold">
            Log your session
        </h2>
        {{ form.hidden_tag() }}


        <div class="mb-4">
            {{ form.date.label(class="form-label") }}
            {{ form.date(class="form-control") }}
        </div>
        <div class="mb-4">
            {{ form.hours.label(class="form-label") }}
            {{ form.hours(class="form-control") }}
        </div>
        <div class="mb-4">
            {{ form.mood.label(class="form-label") }}
            {{ form.mood(class="form-select") }}
        </div>

        <!-- OBSTACLES -->
        <div class="mb-4">
            {{ form.obstacles.label(class="form-label") }}
            {{ form.obstacles(class="form-control", rows="3", id="obstacles-input")  }}
        </div>

        <!-- LESSON -->
        <div class="mb-3">
            {{ form.lesson.label(class="form-label") }}
            {{ form.lesson(class="form-control", rows="3", id="lesson-input") }}
        </div>

        <!-- ACTION PLAN -->
        <div class="mb-3">
            {{ form.action.label(class="form-label") }}
            {{ form.action(class="form-control", rows="3", id="action-input") }}
        </div>

        <!-- Submit -->
        <div>
            {{ form.submit(class="btn btn-primary", value="Update" if result else "Submit") }}
        </div>
    </form>
    <!-- AI FEEDBACK BUTTON -->
    <div class="form-container mt-3">
        <div class="d-inline-block position-relative">
             <button type="button" id="ai-guide-btn" class="btn btn-warning text-dark fw-bold mt-2">
                      üõ†Ô∏è AI Session Guide
                      <span class="spinner-border spinner-border-sm ms-2 d-none"
                            role="status"
                            id="action-spinner"
                            aria-hidden="true"></span>
             </button>
        </div>
         <div id="ai-feedback" class= "alert alert-info mt-3 p-3 rounded-3 fw-semibold shadow-sm d-none"
              style="font-size: 1rem; color: #083358; background-color: rgba(255,255,255,0.8); border-left: 6px solid #4682B4; white-space: pre-wrap;">
         </div>
    </div>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // TEST: Basic click detection
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DEBUG: DOM fully loaded');

            // 1. Initialize toasts
            const toasts = [].slice.call(document.querySelectorAll('.toast'));
            toasts.forEach(function(toast) {
                new bootstrap.Toast(toast, { delay: 4000 }).show();
            });

            // 2. Get all elements
            const elements = {
                button: document.getElementById('ai-guide-btn'),
                spinner: document.getElementById('action-spinner'),
                feedback:  document.getElementById('ai-feedback'),
                obstacles: document.getElementById('obstacles-input'),
                lesson: document.getElementById('lesson-input'),
                action: document.getElementById('action-input'),
                csrf: document.querySelector('input[name="csrf_token"]')
            };

            // 3. Debug: Verify elements
            console.log("Elements found:", {
                button: !!elements.button,
                spinner: !!elements.spinner,
                feedback: !!elements.feedback,
                csrf: !!elements.csrf
            });

            // 4. Safety checks
            if (!elements.button) {
                console.error("‚ùå CRITICAL: AI Guide not found!");
                return;
            }

            if (!elements.csrf) {
                console.error("‚ùå CSRF token element missing!");
                elements.feedback.textContent = "‚ö†Ô∏è Security error detected";
                elements.feedback.classList.remove('d-none');
                return;
            }

            // 5. Click handler with proper event prevention
            elements.button.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('DEBUG: AI Guide button clicked');

                // Get values:
                const values = {
                    obstacles: elements.obstacles.value,
                    lesson: elements.lesson.value,
                    action: elements.action.value
                };

                // Validate
                if (!values.obstacles && !values.lesson && !values.action) {
                    showFeedback('‚ö†Ô∏è Please enter some content first');
                    return;
                }

                // UI Feedback
                showFeedback('üîÑ Analyzing your reflections...', true);
                elements.button.disabled = true;

                try {
                    const response = await fetch(`/ai_guide/reflection`, {
                        method: 'POST',
                        headers: {
                             'Content-Type': 'application/json',
                             'X-CSRFToken': elements.csrf.value
                        },
                        body: JSON.stringify(values)
                    });

                    const data = await response.json();
                    showFeedback(data.feedback.replace(/\n/g, '<br>'));

                 } catch(error) {
                      console.error('Error:', error);
                      showFeedback(`‚ö†Ô∏è Error: ${error.message || 'Please try again'}`);
                 } finally {
                      elements.button.disabled = false;
                 }
            });

            function showFeedback(message, showSpinner = false) {
                elements.feedback.innerHTML = message;
                elements.feedback.classList.remove('d-none');
                if (showSpinner) {
                    elements.spinner.classList.remove('d-none');
                } else {
                    elements.spinner.classList.add('d-none');
                }
            }

            // TEST: Confirm click binding works
            console.log("AI Button event listeners:",
                 getEventListeners(elements.button));
        });
    </script>
</body>
</html>

